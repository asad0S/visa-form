<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>فرم اطلاعات هویتی</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
    /* استایل کلی */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        background-color: #f5f5f5;
        padding: 10px;
        line-height: 1.5;
        color: #333;
        font-family: 'Vazirmatn', Tahoma, sans-serif;
    }
    
    .form-container {
        width: 100%;
        max-width: 1100px;
        margin: 0 auto;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    /* هدر فرم */
    .form-header {
        background: linear-gradient(135deg, #2c5aa0 0%, #4a6fa5 100%);
        color: white;
        padding: 20px 25px;
        text-align: center;
        border-bottom: 4px solid #1e3f7a;
    }
    
    .form-header h1 {
        font-size: 26px;
        margin-bottom: 5px;
        font-weight: 700;
        line-height: 1.2;
    }
    
    .form-header .subtitle {
        font-size: 15px;
        opacity: 0.95;
        font-weight: 500;
    }
    
    /* بخش عکس */
    .photo-section {
        padding: 15px 25px;
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .photo-container {
        width: 180px;
        height: 220px;
        border: 2px solid #cbd5e0;
        background-color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    
    .photo-placeholder {
        text-align: center;
        color: #718096;
        font-size: 14px;
        padding: 15px;
        font-weight: 500;
        line-height: 1.4;
    }
    
    #preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none;
    }
    
    .upload-btn {
        background: linear-gradient(to right, #4a6fa5, #3a5a8a);
        color: white;
        border: none;
        padding: 9px 22px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.3s ease;
        font-family: 'Vazirmatn', sans-serif;
        box-shadow: 0 3px 6px rgba(58, 90, 138, 0.2);
    }
    
    .upload-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(58, 90, 138, 0.3);
    }
    
    /* کد رهگیری */
    .tracking-code {
        background-color: #f1f5f9;
        border: 2px solid #e2e8f0;
        padding: 12px 18px;
        text-align: center;
        font-family: 'Courier New', monospace;
        font-size: 18px;
        letter-spacing: 1.5px;
        font-weight: 700;
        color: #1e293b;
        margin: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    
    .code-label {
        display: block;
        margin-bottom: 8px;
        font-size: 15px;
        color: #475569;
        font-weight: 600;
        font-family: 'Vazirmatn', sans-serif;
        line-height: 1.3;
    }
    
    .code-input {
        width: 100%;
        padding: 9px;
        border: 2px solid #cbd5e0;
        border-radius: 6px;
        font-size: 17px;
        font-weight: 700;
        background-color: #fff;
        text-align: center;
        font-family: 'Courier New', monospace;
        letter-spacing: 2px;
        direction: ltr;
        color: #1e293b;
        outline: none;
        transition: all 0.3s ease;
    }
    
    .code-input:focus {
        border-color: #4a6fa5;
        box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.2);
        background-color: #f8fafc;
    }
    
    /* جدول اطلاعات - طراحی جدید */
    .info-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        margin: 0;
    }
    
    .info-table td {
        border: 1.5px solid #e2e8f0;
        padding: 10px 12px;
        vertical-align: middle;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    
    /* استایل ستون‌ها - طراحی جدید */
    .label-col {
        width: 25%;
        background-color: #edf2f7;
        text-align: right;
        color: #2d3748;
        border-right: 2px solid #cbd5e0;
        font-weight: 700;
        font-size: 13px;
        font-family: 'Vazirmatn', sans-serif;
        white-space: nowrap;
    }
    
    /* فیلدهای فارسی - دو اندازه مختلف */
    .persian-col {
        width: 40%;
        text-align: right;
        font-weight: 700;
        color: #1a202c;
        font-size: 14px;
        font-family: 'Vazirmatn', sans-serif;
        padding-right: 15px;
    }
    
    /* فیلدهای انگلیسی */
    .english-col {
        width: 35%;
        text-align: left;
        direction: ltr;
        color: #1a202c;
        font-weight: 700;
        font-family: 'Roboto', Arial, sans-serif;
        font-size: 14px;
        padding-left: 15px;
    }
    
    /* فیلدهای فارسی بزرگ (از نام پدر به بعد) */
    .persian-col-full {
        width: 75%;
        text-align: right;
        font-weight: 700;
        color: #1a202c;
        font-size: 14px;
        font-family: 'Vazirmatn', sans-serif;
        padding-right: 15px;
    }
    
    /* فیلدهای بزرگ برای آدرس */
    .big-field {
        min-height: 65px;
        resize: vertical;
        line-height: 1.5;
        transition: height 0.2s ease;
        overflow-y: auto;
    }
    
    /* ردیف‌های مخصوص نام‌ها */
    .name-row {
        border-bottom: 2px solid #cbd5e0;
    }
    
    .name-label {
        background-color: #e8f5e9;
        border-right: 2px solid #a5d6a7;
    }
    
    /* رنگ‌بندی ردیف‌ها */
    .info-table tr:nth-child(even) {
        background-color: #f8fafc;
    }
    
    .info-table tr:nth-child(odd) {
        background-color: #fff;
    }
    
    /* افکت hover روی ردیف‌ها */
    .info-table tr:hover {
        background-color: #f0f9ff;
        transition: background-color 0.2s ease;
    }
    
    /* فیلدهای ورودی */
    .form-input {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #cbd5e0;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        background-color: #fff;
        transition: all 0.3s ease;
        outline: none;
        box-sizing: border-box;
        font-family: inherit;
        line-height: 1.5;
        min-height: 38px;
        resize: vertical;
        overflow-y: auto;
    }
    
    .form-input.english {
        font-family: 'Roboto', Arial, sans-serif;
        text-align: left;
        direction: ltr;
        padding-left: 12px;
    }
    
    .form-input.persian {
        font-family: 'Vazirmatn', sans-serif;
        text-align: right;
        direction: rtl;
        padding-right: 12px;
    }
    
    .form-input:focus {
        border-color: #4a6fa5;
        box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.2);
        background-color: #f8fafc;
    }
    
    .form-input::placeholder {
        color: #a0aec0;
        font-weight: 500;
        opacity: 0.7;
    }
    
    /* استایل برای textarea‌هایی که باید بزرگ شوند */
    .auto-expand {
        min-height: 38px;
        max-height: 150px;
        resize: vertical;
        overflow-y: auto;
        transition: height 0.2s ease;
    }
    
    /* دکمه‌های فرم */
    .form-buttons {
        padding: 20px;
        background-color: #f8fafc;
        border-top: 2px solid #e2e8f0;
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 11px 22px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'Vazirmatn', sans-serif;
        min-width: 130px;
    }
    
    .btn-submit {
        background: linear-gradient(to right, #10b981, #059669);
        color: white;
        box-shadow: 0 3px 6px rgba(16, 185, 129, 0.2);
    }
    
    .btn-reset {
        background: linear-gradient(to right, #ef4444, #dc2626);
        color: white;
        box-shadow: 0 3px 6px rgba(239, 68, 68, 0.2);
    }
    
    .btn-clear {
        background: linear-gradient(to right, #6b7280, #4b5563);
        color: white;
        box-shadow: 0 3px 6px rgba(107, 114, 128, 0.2);
    }
    
    /* دکمه جدید برای دانلود PDF */
    .btn-pdf {
        background: linear-gradient(to right, #f59e0b, #d97706);
        color: white;
        box-shadow: 0 3px 6px rgba(245, 158, 11, 0.2);
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 12px rgba(0,0,0,0.15);
    }
    
    /* بخش زیرنویس */
    .info-footer {
        padding: 15px;
        background-color: #f8fafc;
        border-top: 2px solid #e2e8f0;
        text-align: center;
        font-size: 12px;
        color: #64748b;
        font-weight: 500;
        line-height: 1.4;
    }
    
    /* کلاس برای مخفی کردن عناصر هنگام چاپ/PDF */
    .no-print {
        /* این کلاس برای مخفی کردن عناصر در PDF استفاده می‌شود */
    }
    
    /* استایل مخصوص برای PDF */
    .pdf-mode {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        border-radius: 0 !important;
        box-shadow: none !important;
    }
    
    /* واکنش‌گرا */
    @media (max-width: 768px) {
        .form-container {
            border-radius: 6px;
            margin: 5px;
        }
        
        .info-table {
            font-size: 13px;
        }
        
        .info-table td {
            padding: 8px 10px;
        }
        
        .label-col, .persian-col, .english-col, .persian-col-full {
            font-size: 12px;
        }
        
        .photo-container {
            width: 160px;
            height: 200px;
        }
        
        .form-header {
            padding: 12px;
        }
        
        .form-header h1 {
            font-size: 20px;
        }
        
        .tracking-code {
            margin: 8px 10px;
            padding: 10px;
        }
        
        .code-input {
            font-size: 15px;
            padding: 7px;
        }
        
        .form-input {
            padding: 6px 9px;
            font-size: 12px;
            min-height: 36px;
        }
        
        .big-field {
            min-height: 60px;
        }
        
        .form-buttons {
            padding: 15px;
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
            margin-bottom: 6px;
            min-width: auto;
        }
        
        /* در موبایل، همه فیلدهای فارسی را بزرگ نمایش بده */
        .persian-col, .persian-col-full {
            width: 75% !important;
        }
        
        .english-col {
            width: 0% !important;
            display: none !important;
        }
        
        .info-table tr {
            display: block;
            margin-bottom: 5px;
        }
        
        .info-table td {
            display: block;
            width: 100% !important;
            box-sizing: border-box;
        }
    }
</style>
</head>
<body>

<div class="form-container" id="formToPrint">
    <!-- هدر فرم -->
    <div class="form-header">
        <h1>شرکت سیاحتی رستگاران</h1>
    </div>
    
    <!-- بخش عکس -->
    <div class="photo-section">
        <div class="photo-container">
            <div class="photo-placeholder">عکس ۴×۶<br>اضافه کنید</div>
            <img id="preview" alt="تصویر آپلود شده">
        </div>
        <input type="file" id="photo-upload" accept="image/*" style="display: none;" onchange="loadPhoto(event)">
        <button class="upload-btn no-print" onclick="document.getElementById('photo-upload').click()">انتخاب عکس</button>
    </div>
    
    <!-- کد رهگیری -->
    <div class="tracking-code">
        <span class="code-label">نمبر پاسپورت</span>
        <input type="text" class="code-input" id="trackingCode" placeholder="P015211A6AD53B1604">
    </div>
    
    <!-- فرم اطلاعات -->
    <form id="identityForm">
        <table class="info-table">
            <!-- اسم فارسی -->
            <tr>
                <td class="label-col name-label">اسم فارسی</td>
                <td class="persian-col">
                    <input type="text" class="form-input persian auto-expand" id="nameFa" placeholder="نام فارسی را وارد کنید" oninput="autoExpand(this)">
                </td>
                <td class="english-col">
                    <input type="text" class="form-input english english-field auto-expand" id="nameEn" placeholder="Enter English name" oninput="autoExpand(this)">
                </td>
            </tr>
            
            <!-- تخلص فارسی -->
            <tr>
                <td class="label-col name-label">تخلص فارسی</td>
                <td class="persian-col">
                    <input type="text" class="form-input persian auto-expand" id="familyFa" placeholder="تخلص فارسی را وارد کنید" oninput="autoExpand(this)">
                </td>
                <td class="english-col">
                    <input type="text" class="form-input english english-field auto-expand" id="familyEn" placeholder="Enter English family name" oninput="autoExpand(this)">
                </td>
            </tr>
            
            <!-- نام پدر -->
            <tr>
                <td class="label-col">نام پدر</td>
                <td class="persian-col-full" colspan="2">
                    <input type="text" class="form-input persian auto-expand" id="fatherName" placeholder="نام پدر را وارد کنید" oninput="autoExpand(this)">
                </td>
            </tr>
            
            <!-- نام پدر کلان -->
            <tr>
                <td class="label-col">نام پدر کلان</td>
                <td class="persian-col-full" colspan="2">
                    <input type="text" class="form-input persian auto-expand" id="grandfatherName" placeholder="نام پدر کلان را وارد کنید" oninput="autoExpand(this)">
                </td>
            </tr>
            
            <!-- نام مادر -->
            <tr>
                <td class="label-col">نام مادر</td>
                <td class="persian-col-full" colspan="2">
                    <input type="text" class="form-input persian auto-expand" id="motherName" placeholder="نام مادر را وارد کنید" oninput="autoExpand(this)">
                </td>
            </tr>
            
            <!-- آدرس افغانستان -->
            <tr>
                <td class="label-col">آدرس افغانستان</td>
                <td class="persian-col-full" colspan="2">
                    <textarea class="form-input persian big-field auto-expand" id="afghanAddress" placeholder="آدرس دقیق در افغانستان را وارد کنید" oninput="autoExpand(this)"></textarea>
                </td>
            </tr>
            
            <!-- شماره تماس -->
            <tr>
                <td class="label-col">شماره تماس</td>
                <td class="persian-col-full" colspan="2">
                    <input type="tel" class="form-input persian auto-expand" id="phoneNumber" placeholder="مثال: ۰۷۹۹۱۲۳۴۵۶" oninput="autoExpand(this)">
                </td>
            </tr>
            
            <!-- آدرس ایران -->
            <tr>
                <td class="label-col">آدرس ایران</td>
                <td class="persian-col-full" colspan="2">
                    <textarea class="form-input persian big-field auto-expand" id="iranAddress" placeholder="آدرس دقیق در ایران را وارد کنید" oninput="autoExpand(this)"></textarea>
                </td>
            </tr>
            
            <!-- سفارت ایران -->
            <tr>
                <td class="label-col">سفارت ایران</td>
                <td class="persian-col-full" colspan="2">
                    <input type="text" class="form-input persian" id="iranConsulate" value="سرکنسولگری جمهوری اسلامی ایران - مزارشریف" readonly style="background-color: #f1f5f9; border-color: #cbd5e0; font-weight: 700; color: #1a202c;">
                </td>
            </tr>
            
            <!-- شغل -->
            <tr>
                <td class="label-col">شغل</td>
                <td class="persian-col-full" colspan="2">
                    <input type="text" class="form-input persian auto-expand" id="jobFa" placeholder="شغل خود را وارد کنید" oninput="autoExpand(this)">
                </td>
            </tr>
        </table>
        
        <!-- دکمه‌های فرم -->
        <div class="form-buttons no-print">
            <button type="button" class="btn btn-clear" onclick="clearForm()">پاک کردن همه</button>
            <button type="button" class="btn btn-pdf" onclick="downloadPDF()">دانلود فرم PDF</button>
        </div>
    </form>
    
    <!-- بخش زیرنویس -->
    <div class="info-footer no-print">
         سیستم شامل اشتباهات میباشد، با گذشت زمان بهتر میسازیم
    </div>
</div>

<script>
// تابع بارگذاری عکس
function loadPhoto(event) {
    const img = document.getElementById('preview');
    const placeholder = document.querySelector('.photo-placeholder');
    
    if (event.target.files && event.target.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            img.src = e.target.result;
            img.style.display = "block";
            
            if (placeholder) {
                placeholder.style.display = "none";
            }
        }
        
        reader.readAsDataURL(event.target.files[0]);
        
        // تغییر متن دکمه
        const uploadBtn = document.querySelector('.upload-btn');
        uploadBtn.textContent = 'تغییر عکس';
    }
}

// تابع جدید: تنظیم خودکار ارتفاع فیلدها
function autoExpand(field) {
    // ذخیره مقدار فعلی
    const currentValue = field.value;
    
    // تنظیم ارتفاع به auto برای محاسبه ارتفاع واقعی
    field.style.height = 'auto';
    
    // محاسبه ارتفاع جدید بر اساس محتوا
    const newHeight = Math.min(Math.max(field.scrollHeight, 38), 150);
    
    // تنظیم ارتفاع جدید
    field.style.height = newHeight + 'px';
    
    // برای textareaهای بزرگتر
    if (field.classList.contains('big-field')) {
        const bigFieldHeight = Math.min(Math.max(field.scrollHeight, 65), 250);
        field.style.height = bigFieldHeight + 'px';
    }
    
    // اعتبارسنجی در حین تایپ
    validateField(field);
}

// تابع اعتبارسنجی فیلد
function validateField(field) {
    if (field.value.trim()) {
        field.style.borderColor = '#10b981';
    } else {
        field.style.borderColor = '#cbd5e0';
    }
}

// تابع ثبت فرم
function submitForm() {
    // جمع آوری داده‌ها
    const formData = {
        trackingCode: document.getElementById('trackingCode').value,
        nameFa: document.getElementById('nameFa').value,
        nameEn: document.getElementById('nameEn').value,
        familyFa: document.getElementById('familyFa').value,
        familyEn: document.getElementById('familyEn').value,
        fatherName: document.getElementById('fatherName').value,
        grandfatherName: document.getElementById('grandfatherName').value,
        motherName: document.getElementById('motherName').value,
        afghanAddress: document.getElementById('afghanAddress').value,
        phoneNumber: document.getElementById('phoneNumber').value,
        iranAddress: document.getElementById('iranAddress').value,
        iranConsulate: document.getElementById('iranConsulate').value,
        jobFa: document.getElementById('jobFa').value
    };
    
    // اعتبارسنجی ساده
    let isValid = true;
    const requiredFields = ['trackingCode', 'nameFa', 'familyFa', 'fatherName'];
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            field.style.borderColor = '#ef4444';
            isValid = false;
        } else {
            field.style.borderColor = '#10b981';
        }
    });
    
    // اعتبارسنجی شماره تماس
    const phoneField = document.getElementById('phoneNumber');
    const phoneValue = phoneField.value.trim();
    if (phoneValue && !/^[\d۰-۹]{10,}$/.test(phoneValue.replace(/[\s\-]/g, ''))) {
        phoneField.style.borderColor = '#ef4444';
        isValid = false;
        alert('لطفاً شماره تماس معتبر وارد کنید (حداقل ۱۰ رقم)');
    }
    
    if (isValid) {
        // نمایش داده‌ها در کنسول
        console.log('اطلاعات ثبت شد:', formData);
        
        // نمایش پیام موفقیت
        alert('اطلاعات با موفقیت ثبت شد!');
    } else {
        alert('لطفاً فیلدهای الزامی (کود، اسم فارسی، تخلص فارسی و نام پدر) را پر کنید.');
    }
}

// تابع بازنشانی فرم به مقادیر اولیه
function resetForm() {
    document.getElementById('identityForm').reset();
    document.getElementById('trackingCode').value = '';
    
    // تنظیم مجدد مقادیر پیش‌فرض سفارت
    document.getElementById('iranConsulate').value = 'سرکنسولگری جمهوری اسلامی ایران - مزارشریف';
    
    // بازنشانی ارتفاع فیلدها
    const inputs = document.querySelectorAll('.form-input, .code-input, .auto-expand');
    inputs.forEach(input => {
        input.style.borderColor = '#cbd5e0';
        input.style.height = 'auto';
        
        if (input.classList.contains('big-field')) {
            input.style.minHeight = '65px';
            input.style.height = '65px';
        } else {
            input.style.minHeight = '38px';
            input.style.height = 'auto';
        }
    });
    
    alert('فرم به حالت اولیه بازنشانی شد.');
}

// تابع پاک کردن کامل فرم
function clearForm() {
    const inputs = document.querySelectorAll('.form-input, .code-input');
    inputs.forEach(input => {
        if (!input.hasAttribute('readonly')) {
            input.value = '';
            input.style.borderColor = '#cbd5e0';
            input.style.height = 'auto';
            
            if (input.classList.contains('big-field')) {
                input.style.minHeight = '65px';
                input.style.height = '65px';
            }
        }
    });
    
    // حذف عکس
    const img = document.getElementById('preview');
    const placeholder = document.querySelector('.photo-placeholder');
    img.style.display = "none";
    img.src = "";
    placeholder.style.display = "block";
    
    const uploadBtn = document.querySelector('.upload-btn');
    uploadBtn.textContent = 'انتخاب عکس';
    
    document.getElementById('photo-upload').value = "";
    
    alert('تمامی فیلدها پاک شدند.');
}

// تابع بهبود یافته: دانلود PDF با رفع مشکل فونت فارسی
function downloadPDF() {
    // نمایش پیام در حال بارگذاری
    const loadingMessage = document.createElement('div');
    loadingMessage.textContent = 'در حال ایجاد PDF با کیفیت بالا... لطفاً صبر کنید';
    loadingMessage.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.85);
        color: white;
        padding: 25px 40px;
        border-radius: 12px;
        z-index: 99999;
        font-family: 'Vazirmatn';
        font-size: 18px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    `;
    document.body.appendChild(loadingMessage);
    
    // ذخیره سبک اصلی فرم
    const originalContainer = document.getElementById('formToPrint');
    
    // ایجاد یک clone از فرم برای پردازش PDF
    const clone = originalContainer.cloneNode(true);
    
    // تنظیمات clone برای PDF - کاملاً فشرده در یک صفحه A4
    clone.style.width = '205mm'; // کامل برای A4
    clone.style.maxWidth = '205mm';
    clone.style.margin = '2mm auto';
    clone.style.padding = '5mm';
    clone.style.boxSizing = 'border-box';
    clone.style.backgroundColor = '#ffffff';
    clone.style.borderRadius = '0';
    clone.style.boxShadow = 'none';
    clone.style.lineHeight = '1.3'; // کاهش line-height برای صرفه‌جویی در فضا
    
    // افزایش ضخامت خطوط مرزی برای وضوح بیشتر در PDF
    clone.style.borderWidth = '2px';
    
    // کاهش فاصله‌ها برای PDF
    const header = clone.querySelector('.form-header');
    if (header) {
        header.style.padding = '10px 12px';
        header.style.marginBottom = '2px';
        header.style.fontSize = '22px';
    }
    
    const photoSection = clone.querySelector('.photo-section');
    if (photoSection) {
        photoSection.style.padding = '8px 12px';
        photoSection.style.marginBottom = '2px';
    }
    
    const photoContainer = clone.querySelector('.photo-container');
    if (photoContainer) {
        photoContainer.style.width = '130px';
        photoContainer.style.height = '160px';
        photoContainer.style.marginBottom = '6px';
        photoContainer.style.borderWidth = '2px';
    }
    
    const trackingCode = clone.querySelector('.tracking-code');
    if (trackingCode) {
        trackingCode.style.margin = '6px 8px';
        trackingCode.style.padding = '8px 10px';
        trackingCode.style.fontSize = '13px';
        trackingCode.style.borderWidth = '2px';
    }
    
    // کاهش فاصله‌های جدول
    const table = clone.querySelector('.info-table');
    if (table) {
        table.style.fontSize = '12px';
        table.style.marginTop = '1px';
        table.style.borderWidth = '2px';
    }
    
    // افزایش ضخامت تمام خطوط جدول
    const tableCells = clone.querySelectorAll('.info-table td');
    tableCells.forEach(cell => {
        cell.style.padding = '5px 7px';
        cell.style.borderWidth = '1.5px';
        cell.style.lineHeight = '1.2';
        
        // برای ستون برچسب، فونت را کمی بزرگتر کن
        if (cell.classList.contains('label-col')) {
            cell.style.fontSize = '12px';
            cell.style.fontWeight = '800';
        }
    });
    
    // تنظیم فونت و اندازه فیلدها برای PDF با فونت فارسی بهتر
    const formInputs = clone.querySelectorAll('.form-input, .code-input');
    formInputs.forEach(input => {
        input.style.padding = '6px 10px';
        input.style.fontSize = '12px';
        input.style.lineHeight = '1.4'; // افزایش line-height برای خوانایی بهتر
        input.style.minHeight = '32px';
        input.style.borderWidth = '1.5px';
        input.style.fontFamily = "'Vazirmatn', Tahoma, sans-serif !important";
        
        // برای فیلدهای فارسی، padding را تنظیم کن
        if (input.classList.contains('persian')) {
            input.style.paddingRight = '15px';
            input.style.textAlign = 'right';
            input.style.direction = 'rtl';
            input.style.fontWeight = '700';
            input.style.letterSpacing = 'normal';
            input.style.wordSpacing = 'normal';
        }
        
        // برای فیلدهای انگلیسی
        if (input.classList.contains('english')) {
            input.style.paddingLeft = '15px';
            input.style.fontFamily = "'Roboto', Arial, sans-serif !important";
        }
        
        // تنظیم ارتفاع فیلدهای با محتوای زیاد
        if (input.scrollHeight > input.offsetHeight) {
            input.style.height = Math.min(input.scrollHeight, 180) + 'px';
        }
    });
    
    // تنظیم ارتفاع فیلدهای بزرگ برای PDF
    const bigFields = clone.querySelectorAll('.big-field');
    bigFields.forEach(field => {
        field.style.minHeight = '45px';
        field.style.height = 'auto';
        field.style.lineHeight = '1.5';
        field.style.fontSize = '12px';
        field.style.fontWeight = '700';
        
        // اگر محتوایی دارد، ارتفاع را بر اساس آن تنظیم کن
        if (field.value.trim()) {
            const scrollHeight = field.scrollHeight;
            field.style.height = Math.min(Math.max(scrollHeight, 45), 200) + 'px';
        } else {
            field.style.height = '45px';
        }
    });
    
    // تنظیم فیلد سفارت ایران برای نمایش کامل متن فارسی
    const consulateField = clone.querySelector('#iranConsulate');
    if (consulateField) {
        consulateField.style.fontSize = '13px';
        consulateField.style.fontWeight = '800';
        consulateField.style.color = '#1a202c';
        consulateField.style.paddingRight = '15px';
        consulateField.style.letterSpacing = 'normal';
    }
    
    // کاهش footer
    const footer = clone.querySelector('.info-footer');
    if (footer) {
        footer.style.padding = '8px';
        footer.style.fontSize = '10px';
        footer.style.marginTop = '2px';
    }
    
    // مخفی کردن دکمه‌ها و عناصر غیرضروری
    const noPrintElements = clone.querySelectorAll('.no-print');
    noPrintElements.forEach(el => {
        el.style.display = 'none';
        el.style.visibility = 'hidden';
        el.style.opacity = '0';
        el.style.height = '0';
        el.style.padding = '0';
        el.style.margin = '0';
    });
    
    // افزودن clone به body (مخفی)
    clone.style.position = 'absolute';
    clone.style.left = '-9999px';
    clone.style.top = '0';
    document.body.appendChild(clone);
    
    // تنظیمات بسیار بهبود یافته برای html2canvas با پشتیبانی کامل از فارسی
    const options = {
        scale: 4, // افزایش کیفیت به بالاترین حد
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: false,
        allowTaint: false,
        removeContainer: true,
        width: 794, // عرض A4 در پیکسل
        height: 1123, // ارتفاع A4 در پیکسل
        windowWidth: 794,
        windowHeight: 1123,
        imageTimeout: 30000, // افزایش زمان انتظار
        onclone: function(clonedDoc, element) {
            // بارگذاری فونت Vazirmatn برای نمایش بهتر فارسی
            const style = document.createElement('style');
            style.textContent = `
                @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&display=swap');
                
                * {
                    font-family: 'Vazirmatn', Tahoma, sans-serif !important;
                    text-rendering: geometricPrecision !important;
                    -webkit-font-smoothing: antialiased !important;
                    -moz-osx-font-smoothing: grayscale !important;
                }
                
                .form-input.persian, #iranConsulate {
                    font-family: 'Vazirmatn', Tahoma, sans-serif !important;
                    font-weight: 700 !important;
                    letter-spacing: 0 !important;
                    word-spacing: normal !important;
                }
                
                .form-input.english {
                    font-family: 'Roboto', Arial, sans-serif !important;
                }
                
                .label-col {
                    font-weight: 800 !important;
                }
                
                /* اطمینان از نمایش کامل حروف فارسی */
                [dir="rtl"] {
                    text-align: right !important;
                    unicode-bidi: embed !important;
                }
            `;
            clonedDoc.head.appendChild(style);
            
            // بهبود نمایش تمام عناصر
            const allElements = element.querySelectorAll('*');
            allElements.forEach(el => {
                // تضمین نمایش کامل متن فارسی
                el.style.textIndent = '0';
                el.style.overflow = 'visible';
                el.style.whiteSpace = 'normal';
                el.style.lineHeight = '1.3';
                el.style.letterSpacing = 'normal';
                el.style.wordSpacing = 'normal';
                el.style.textRendering = 'geometricPrecision';
                el.style.WebkitFontSmoothing = 'antialiased';
                el.style.MozOsxFontSmoothing = 'grayscale';
                
                // برای نمایش کامل حروف پیوسته فارسی
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'TD') {
                    el.style.fontKerning = 'normal';
                    el.style.fontFeatureSettings = '"kern" 1, "liga" 1, "clig" 1, "calt" 1';
                    
                    // اطمینان از نمایش کامل متن در فیلدها
                    if (el.value && el.value.includes('س')) {
                        el.style.padding = '6px 12px !important';
                        el.style.boxSizing = 'border-box';
                    }
                }
                
                // تنظیم خاص برای فیلد سفارت
                if (el.id === 'iranConsulate') {
                    el.style.fontSize = '13px !important';
                    el.style.fontWeight = '800 !important';
                    el.style.paddingRight = '15px !important';
                    el.style.color = '#1a202c !important';
                }
            });
            
            // افزایش ضخامت خطوط مرزی
            const borders = element.querySelectorAll('td, .photo-container, .tracking-code, .form-input');
            borders.forEach(borderEl => {
                borderEl.style.borderWidth = '1.5px';
                borderEl.style.borderStyle = 'solid';
                borderEl.style.borderColor = borderEl.style.borderColor || '#e2e8f0';
            });
        }
    };
    
    // ایجاد timeout برای اطمینان از بارگذاری فونت‌ها
    setTimeout(() => {
        html2canvas(clone, options).then(canvas => {
            // حذف clone از DOM
            document.body.removeChild(clone);
            document.body.removeChild(loadingMessage);
            
            // ایجاد PDF با کیفیت بالا
            const pdf = new window.jspdf.jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                compress: true,
                hotfixes: ["px_scaling"]
            });
            
            // ابعاد A4
            const pageWidth = 210;
            const pageHeight = 297;
            
            // تبدیل canvas به تصویر با کیفیت بالا
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            
            // محاسبه ابعاد تصویر برای پر کردن کامل صفحه
            // با حاشیه بسیار کم (2mm از هر طرف)
            const imgWidth = pageWidth - 4;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            // افزودن تصویر به PDF با موقعیت دقیق
            pdf.addImage(imgData, 'JPEG', 2, 2, imgWidth, imgHeight, '', 'FAST');
            
            // ذخیره فایل PDF
            const trackingCode = document.getElementById('trackingCode').value;
            const fileName = trackingCode ? `فرم-${trackingCode}.pdf` : 'فرم-اطلاعات-هویتی.pdf';
            
            // نمایش پیام موفقیت
            setTimeout(() => {
                pdf.save(fileName);
                alert('✅ PDF با کیفیت عالی ایجاد شد!\n• فرم کامل در یک صفحه A4 قرار گرفته\n• فیلدهای فارسی بزرگ شده‌اند\n• مشکل نمایش حروف فارسی برطرف شد');
            }, 500);
            
        }).catch(error => {
            // حذف clone در صورت خطا
            if (document.body.contains(clone)) {
                document.body.removeChild(clone);
            }
            if (document.body.contains(loadingMessage)) {
                document.body.removeChild(loadingMessage);
            }
            
            console.error('خطا در ایجاد PDF:', error);
            alert('❌ خطایی در ایجاد PDF رخ داد. لطفاً دوباره تلاش کنید.\nخطا: ' + error.message);
        });
    }, 500); // تأخیر برای بارگذاری فونت‌ها
}

// تنظیمات اولیه
document.addEventListener('DOMContentLoaded', function() {
    // تغییر رنگ ردیف‌ها هنگام hover
    const rows = document.querySelectorAll('.info-table tr');
    
    rows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f0f9ff';
        });
        
        row.addEventListener('mouseleave', function() {
            const index = Array.from(rows).indexOf(this);
            this.style.backgroundColor = index % 2 === 0 ? '#fff' : '#f8fafc';
        });
    });
    
    // اعتبارسنجی هنگام خروج از فیلد
    const inputs = document.querySelectorAll('.form-input, .code-input');
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            validateField(this);
        });
        
        // تنظیم خودکار ارتفاع در ابتدا برای فیلدهای پر
        if (input.value.trim()) {
            autoExpand(input);
        }
    });
    
    // فرمت خودکار شماره تماس
    const phoneInput = document.getElementById('phoneNumber');
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/^0/, '۰');
        e.target.value = value;
        autoExpand(this);
    });
    
    // اعمال autoExpand بر روی تمام فیلدهای auto-expand
    const autoExpandFields = document.querySelectorAll('.auto-expand');
    autoExpandFields.forEach(field => {
        // تنظیم ارتفاع اولیه
        autoExpand(field);
    });
    
    // تنظیم مقدار پیش‌فرض سفارت ایران
    document.getElementById('iranConsulate').value = 'سرکنسولگری جمهوری اسلامی ایران - مزارشریف';
});
</script>
</body>
</html>